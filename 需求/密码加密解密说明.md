# 密码加密与解密说明文档

## 概述

本系统采用AES对称加密算法对用户密码进行可逆加密存储,便于后续数据迁移和特殊情况下的密码恢复。

## 加密算法

**算法**: AES (Advanced Encryption Standard)
**模式**: CBC
**填充**: PKCS5Padding
**密钥长度**: 128位

## 密钥配置

### 配置文件位置
`backend/src/main/resources/application.yml`

### 配置内容
```yaml
aes:
  secret-key: shixiaoyun-aes-secret-2024-key
```

**重要提示**:
- 此密钥仅用于开发环境
- **生产环境必须修改为复杂的随机密钥**
- 密钥长度建议32个字符
- 密钥应通过环境变量或配置中心管理,不应硬编码或提交到代码仓库

## 加密流程

### 代码示例

#### Java加密
```java
import com.shixiaoyun.utils.AESUtil;

// 明文密码
String plainPassword = "password123";

// 加密
String encryptedPassword = AESUtil.encrypt(plainPassword);
// 结果示例: "Kx8Qw2vN5pY7rT3zL1mH6nJ9kU4sA=="

// 存储到数据库
user.setPassword(encryptedPassword);
```

#### Java解密
```java
import com.shixiaoyun.utils.AESUtil;

// 从数据库读取的密文
String encryptedPassword = user.getPassword();

// 解密
String plainPassword = AESUtil.decrypt(encryptedPassword);
// 结果: "password123"
```

## 数据迁移时的密码处理

### 场景1: 导出数据到其他系统

如果需要将用户数据导出到其他系统,可以批量解密密码:

```java
import com.shixiaoyun.utils.AESUtil;
import com.shixiaoyun.mapper.UserMapper;
import com.shixiaoyun.entity.User;
import java.util.List;

// 查询所有用户
List<User> users = userMapper.selectList(null);

// 批量解密密码
for (User user : users) {
    String encryptedPassword = user.getPassword();
    String plainPassword = AESUtil.decrypt(encryptedPassword);

    // 输出或导出到新系统
    System.out.println("用户: " + user.getPhone() + ", 密码: " + plainPassword);
}
```

### 场景2: 从其他系统迁入数据

如果从其他系统迁入用户数据,需要对明文密码进行加密:

```java
import com.shixiaoyun.utils.AESUtil;

// 从其他系统导入的明文密码
String plainPassword = "user_password";

// 加密后存储
String encryptedPassword = AESUtil.encrypt(plainPassword);
user.setPassword(encryptedPassword);
userMapper.insert(user);
```

## 单个密码解密工具

### 命令行工具

创建一个简单的Java工具类用于单个密码解密:

```java
package com.shixiaoyun.utils;

public class PasswordDecryptTool {

    public static void main(String[] args) {
        if (args.length < 1) {
            System.out.println("使用方法: java PasswordDecryptTool <加密密码>");
            return;
        }

        String encryptedPassword = args[0];

        try {
            // 注意: 需要确保使用与生产环境相同的密钥
            String plainPassword = AESUtil.decrypt(encryptedPassword);
            System.out.println("解密结果: " + plainPassword);
        } catch (Exception e) {
            System.err.println("解密失败: " + e.getMessage());
        }
    }
}
```

使用方法:
```bash
cd backend
mvn clean package
java -cp target/shixiaoyun-backend-1.0.0.jar com.shixiaoyun.utils.PasswordDecryptTool "Kx8Qw2vN5pY7rT3zL1mH6nJ9kU4sA=="
```

## SQL批量解密

如果需要在数据库层面批量查看明文密码(仅用于数据迁移),可以创建临时存储过程:

**注意**: 以下操作仅用于数据迁移,完成后应立即删除相关代码和临时表。

```sql
-- 创建临时表存储解密结果
CREATE TABLE temp_user_passwords (
    user_id BIGINT,
    phone VARCHAR(11),
    encrypted_password VARCHAR(255),
    plain_password VARCHAR(255)
);

-- 需要在应用层解密,此处仅为示例
-- 实际操作应使用Java程序批量处理
```

## 安全建议

### 1. 密钥管理
- ✅ 使用环境变量存储密钥
- ✅ 使用配置中心(如Apollo、Nacos)管理密钥
- ❌ 不要将密钥硬编码在代码中
- ❌ 不要将密钥提交到代码仓库
- ❌ 不要在日志中输出密钥

### 2. 访问控制
- 限制能够访问解密功能的人员
- 记录所有解密操作的审计日志
- 定期更换密钥(需要重新加密所有密码)

### 3. 生产环境配置

**方式1: 环境变量**
```bash
export AES_SECRET_KEY="your-production-secret-key-32-chars"
```

```yaml
aes:
  secret-key: ${AES_SECRET_KEY}
```

**方式2: 配置中心**
使用Spring Cloud Config或Nacos管理敏感配置

### 4. 数据迁移流程

1. 备份数据库
2. 导出加密密码
3. 使用工具批量解密
4. 导入到新系统
5. 删除临时明文密码文件
6. 验证迁移结果

## 常见问题

### Q1: 忘记密钥怎么办?
A: 如果密钥丢失,无法解密已加密的密码。建议:
- 定期备份密钥
- 使用多人管理的密钥托管方案
- 提供密码重置功能给用户

### Q2: 如何更换密钥?
A: 需要:
1. 使用旧密钥解密所有密码
2. 更新密钥配置
3. 使用新密钥重新加密所有密码
4. 更新数据库

### Q3: AES加密是否安全?
A: AES是目前广泛使用的对称加密算法,在正确使用的情况下是安全的。但请注意:
- 密钥必须足够复杂
- 密钥必须妥善保管
- 建议配合HTTPS使用
- 建议添加访问控制和审计日志

## 技术支持

如有密码加解密相关问题,请联系开发团队。

**重要提醒**:
- 密码解密功能仅用于合法的数据迁移场景
- 禁止未经授权访问或解密用户密码
- 必须遵守相关法律法规和隐私政策

---

**文档版本**: 1.0
**最后更新**: 2024年11月
**维护团队**: 视消云开发团队
