# 安全与加密设计说明

## 一、文档信息
- **文档目的**：定义本系统的安全策略、认证与授权方案、密码与可逆加密方案，以及敏感数据保护与日志审计要求，满足需求中对“账号密码加密存储、密码可逆并可提供逆向方式”的要求。
- **适用读者**：后端开发、架构师、安全审核人员、运维工程师。
- **关联文档**：
  - 《系统总体架构设计说明》
  - 《业务模块与接口分层设计文档》
  - 《需求.md》《任务列表.md》1.3 小节

## 二、总体安全目标
- 确保用户账号、密码等敏感信息在存储与传输过程中不明文暴露。
- 确保只有授权用户才能访问对应资源（最小权限原则）。
- 在满足可逆密码要求的前提下，尽量降低密钥泄露带来的风险。
- 提供必要的日志与审计能力，支持问题追踪与安全事件分析。

## 三、身份认证与授权设计

### 3.1 认证方式
- 小程序端：
  - 使用 Token 机制（建议 JWT）表示登录态。
  - 登录成功后，后端生成包含用户 ID、角色、过期时间等信息的 Token 返回给前端。
- 后台管理端 Web：
  - 同样采用 Token 机制（可存储在 HttpOnly Cookie 或前端 LocalStorage，根据部署环境选择）。

### 3.2 授权模型
- 使用「用户-角色-权限」模型：
  - 用户（User）可关联多个角色（Role）。
  - 角色对应权限集合（Permission），用于控制访问 `/api/admin/**` 等敏感接口。
- 授权实现：
  - 在网关/应用入口对 Token 进行校验与解析。
  - 在 Controller 层使用注解（如 `@PreAuthorize` 或自定义注解）声明接口访问所需角色/权限。

### 3.3 Token 策略
- Token 中仅保存必要信息：用户 ID、角色标识、签发时间、过期时间、签名。
- 设置合理过期时间（如 2 小时或 1 天），支持刷新 Token 机制。
- Token 使用服务端密钥签名，该密钥不写死在代码中，而是通过环境变量或配置中心管理。

## 四、密码存储与可逆加密方案

> 需求要求：账号密码需加密存储且“密码要可逆，为了后续方便数据迁移，交付时提供密码逆向方式”。

### 4.1 设计原则
- 不在数据库中存储明文密码。
- 使用对称加密算法（如 AES）对密码进行加密后存储，以满足“可逆”的要求。
- 加密密钥只存储在安全位置（环境变量、独立配置），不写死在代码和仓库中。

### 4.2 加密方案概述
- 算法选择：
  - 对称加密算法：AES-256-CBC（示例，可根据运行环境做适配）。
- 数据库存储字段：
  - `password_enc`：存储加密后的密码字符串（Base64 或 Hex 编码）。
  - 如需进一步增强安全性，可在业务侧对明文密码做一次不可逆摘要（如 SHA-256+Salt），再对摘要结果进行 AES 加密存储。
- 加密流程（注册/修改密码时）：
  1. 用户提交明文密码给后端（通过 HTTPS 传输）。
  2. 后端使用约定的 AES 密钥与 IV，对密码或密码摘要进行加密。
  3. 将加密后的密文保存到 `password_enc` 字段。
- 校验流程（登录时）：
  - 方案 A：对用户输入的密码执行同样的「摘要 + AES 加密」，与数据库中的密文进行对比。
  - 或方案 B：从数据库中取出密文，解密得到原始摘要/密码，再与用户输入的摘要/密码对比（推荐使用 A，尽量少做解密操作）。

### 4.3 密钥管理
- AES 密钥与 IV：
  - 存放在服务启动时读取的环境变量或独立的配置文件中，避免写死在代码仓库。
  - 示例环境变量：`APP_PASS_AES_KEY`、`APP_PASS_AES_IV`。
- 访问控制：
  - 限制仅应用进程和少数运维人员可访问密钥配置。
  - 如条件允许，可使用专门的密钥管理服务（KMS）。

### 4.4 密码逆向方式说明（交付要求）
- 提供一个独立的小工具或脚本（如 Java 命令行程序），
  - 接收数据库中导出的 `password_enc` 字段值，
  - 使用与生产环境相同的 AES 密钥与 IV 进行解密，
  - 输出对应的明文密码或中间摘要值。
- 在《密码逆向使用说明》中记录：
  - 使用的算法与模式（如 AES-256-CBC）。
  - 所需的密钥、IV 的来源（环境变量名）。
  - 解密工具的使用步骤与示例。

## 五、敏感数据与脱敏策略

### 5.1 敏感数据范围
- 用户密码（加密存储）。
- 手机号、邮箱。
- 身份标识（如 CRM 客户号）。
- 支付相关信息：交易号、订单号、部分卡号/账号信息（如涉及）。

### 5.2 存储与展示原则
- 数据库存储：
  - 手机号、邮箱可明文存储，但前端展示时做脱敏处理（如 138****1234）。
  - CRM 客户号可明文存储，但仅在必要界面展示。
- 前端展示：
  - 对手机号、邮箱等敏感信息统一使用脱敏格式显示。
- 接口返回：
  - 对外接口返回时不返回敏感字段或仅返回脱敏后的值。

## 六、接口安全与传输安全

### 6.1 HTTPS 与域名
- 所有对外暴露的接口必须通过 HTTPS 访问，防止中间人攻击与明文窃听。
- Nginx 负责 TLS 终止，并将请求转发给后端应用。

### 6.2 常见安全问题防护
- 防 SQL 注入：
  - 严格使用 MyBatis-Plus 参数绑定，避免拼接 SQL。
- 防 XSS：
  - 对用户可编辑内容（帖子、评论）在展示时做转义或 HTML 过滤。
- CSRF：
  - 小程序端主要通过 Token 鉴权，风险较低；后台管理端如使用 Cookie，需配合 CSRF Token 或同源策略。

## 七、日志、审计与风控（简要）

### 7.1 日志记录
- 记录以下关键操作日志：
  - 登录成功/失败、修改密码。
  - 积分变动（任务奖励、兑换、抽奖）。
  - 兑换红包、提现、支付结果。
- 日志中避免记录明文密码和完整的敏感信息。

### 7.2 审计与对账
- 对支付与提现操作：
  - 记录交易号、金额、时间、状态、回调结果等信息。
  - 便于与微信支付/对公账户账单进行对账。

## 八、实施与检查要点
- 在开发阶段：
  - 落实密码加密/解密工具类，确保所有密码操作都通过统一入口完成。
  - 在测试环境验证加密、登录、密码重置等流程正确无误。
- 在上线前：
  - 检查所有对外接口是否开启 HTTPS。
  - 检查配置中是否存在硬编码明文密钥。
  - 完成一次基础安全自查，涵盖注入、XSS、权限绕过等问题。
