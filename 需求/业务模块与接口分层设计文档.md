# 业务模块与接口分层设计文档

## 一、文档信息
- **文档目的**：定义本系统的业务模块划分、每个模块的职责边界，以及对外暴露的核心 REST 接口形态，为前后端联调和后续扩展提供依据。
- **适用读者**：架构师、后端开发、前端开发、测试人员。
- **关联文档**：
  - 《系统总体架构设计说明》
  - 《安全与加密设计说明》
  - 《需求.md》《任务列表.md》

## 二、业务模块划分总览

本系统后端按业务域划分为以下模块（单体应用内的逻辑模块）：
- 用户与权限模块
- 积分中心模块
- 任务与模板模块
- 社区内容模块
- 积分商城与奖品模块
- 支付与结算模块
- 集成模块（CRM、mall.wisualarm.com、消息推送）

每个模块内部包含 Controller / Service / Repository 分层，对外通过 REST 接口暴露能力。

## 三、模块职责与核心接口示例

### 3.1 用户与权限模块
- **职责**：
  - 管理用户基本信息、账号状态。
  - 提供注册、登录、退出登录、修改密码等能力。
  - 维护角色、权限、后台账号。
  - 提供与 CRM 的用户映射能力。
- **主要实体**：User、Role、Permission、UserRole、UserCrmMapping 等。
- **核心接口示例**（仅示意路径与功能）：
  - `POST /api/auth/register`：用户注册。
  - `POST /api/auth/login`：账号密码/验证码登录。
  - `POST /api/auth/wechat-login`：微信授权登录。
  - `POST /api/auth/logout`：退出登录。
  - `PUT  /api/user/profile`：修改个人信息。
  - `GET  /api/user/profile`：获取当前登录用户信息。
  - `POST /api/admin/users`：后台创建/编辑用户（仅管理员）。
  - `POST /api/admin/crm/import`：导入 CRM 用户映射数据。

### 3.2 积分中心模块
- **职责**：
  - 维护用户积分账户。
  - 记录积分变动流水。
  - 管理积分规则（如签到、任务奖励、兑换消耗）。
- **主要实体**：PointAccount、PointTransaction、PointRule 等。
- **核心接口示例**：
  - `GET  /api/points/account`：查询当前用户积分账户信息。
  - `GET  /api/points/transactions`：查询积分流水（支持分页、筛选）。
  - `GET  /api/admin/points/rules`：查询积分规则配置。
  - `PUT  /api/admin/points/rules`：修改积分规则（后台）。

### 3.3 任务与模板模块
- **职责**：
  - 定义任务模板（问卷、签到、上传截图/视频等）。
  - 管理任务基本信息（名称、类型、时间、奖励积分、适用人群等）。
  - 记录用户任务参与与提交内容。
  - 与积分中心交互，在审核通过后发放积分。
- **主要实体**：TaskTemplate、Task、TaskParticipation、TaskSubmission、TaskReview 等。
- **核心接口示例**：
  - `GET  /api/tasks`：小程序端任务列表（含任务类型、积分奖励等）。
  - `GET  /api/tasks/{id}`：任务详情。
  - `POST /api/tasks/{id}/submit`：提交任务结果（问卷链接、截图 URL、视频 URL 等）。
  - `GET  /api/admin/tasks`：后台任务列表（筛选、分页）。
  - `POST /api/admin/tasks`：创建/编辑任务。
  - `GET  /api/admin/tasks/submissions`：任务提交记录查询（待审核）。
  - `POST /api/admin/tasks/submissions/{id}/approve`：审核通过并发放积分。
  - `POST /api/admin/tasks/submissions/{id}/reject`：审核驳回。

### 3.4 社区内容模块
- **职责**：
  - 管理社区板块分类（官方咨询、产品建议、新品测评、好物分享）。
  - 管理帖子、评论、点赞等用户生成内容。
  - 可选：支持内容审核机制。
- **主要实体**：Post、PostCategory、Comment、Like 等。
- **核心接口示例**：
  - `GET  /api/community/posts`：帖子列表（支持按分类筛选）。
  - `GET  /api/community/posts/{id}`：帖子详情。
  - `POST /api/community/posts`：创建帖子。
  - `POST /api/community/posts/{id}/comments`：发表评论。
  - `POST /api/community/posts/{id}/like`：点赞/取消点赞。
  - `GET  /api/admin/community/posts`：后台内容列表，支持审核/屏蔽（如需要）。

### 3.5 积分商城与奖品模块
- **职责**：
  - 管理礼品/商品信息、库存、上下架。
  - 处理用户积分兑换礼品。
  - 记录兑换与发放过程，包括现金红包、卡券等。
- **主要实体**：RewardItem、Inventory、RedemptionRecord、WithdrawRecord、Blacklist 等。
- **核心接口示例**：
  - `GET  /api/mall/items`：前端积分商城商品列表。
  - `POST /api/mall/items/{id}/redeem`：发起积分兑换。
  - `GET  /api/mall/redemptions`：用户个人兑换记录。
  - `GET  /api/admin/mall/items`：后台商品管理列表。
  - `POST /api/admin/mall/items`：新增/编辑商品。
  - `GET  /api/admin/mall/redemptions`：兑换记录查询。
  - `GET  /api/admin/mall/withdrawals`：提现记录查询与对账。

### 3.6 支付与结算模块
- **职责**：
  - 与微信支付、企业付款到零钱/对公账户对接。
  - 支撑积分兑换现金红包、微信提现等业务流程。
  - 提供对账所需数据（交易号、金额、状态等）。
- **主要实体**：PaymentOrder、WithdrawalOrder、SettlementRecord 等。
- **核心接口示例**：
  - `POST /api/payments/redeem`：创建红包兑换支付订单（内部调用微信接口）。
  - `POST /api/payments/notify`：接收微信支付回调通知。
  - `GET  /api/admin/payments/settlements`：对账数据查询。

### 3.7 集成模块
- **职责**：
  - 对接 CRM：导入/同步客户数据，建立 user ↔ CRM 客户映射。
  - mall.wisualarm.com 集成：处理参数签名、单点登录或 Token 透传（如需要）。
  - 消息推送：基于 RabbitMQ 发送任务通知或积分到账消息。
- **核心接口/能力示例**：
  - `POST /api/integration/crm/import`：从文件/接口导入 CRM 数据。
  - `GET  /api/integration/crm/users/{id}`：查询绑定的 CRM 客户信息。
  - mall.wisualarm.com：通过 URL 参数或 Header 传递用户标识/Token（细节在对接时确定）。
  - 消息推送：内部服务封装，不直接对外暴露 HTTP 接口。

## 四、接口分层与命名约定

### 4.1 URL 命名规范
- 统一使用 REST 风格：资源名使用复数英文小写，使用 HTTP 方法体现操作语义。
- 小程序 C 端接口统一以 `/api/` 开头；后台管理端接口统一以 `/api/admin/` 开头。
- 示例：
  - `/api/tasks`、`/api/points/account`、`/api/mall/items`
  - `/api/admin/tasks`、`/api/admin/mall/items`

### 4.2 请求与响应格式
- 请求体统一使用 JSON。
- 响应包统一使用 "code + message + data" 的结构，例如：
  - `code`：业务状态码（0 表示成功，非 0 表示失败）。
  - `message`：简要说明。
  - `data`：实际业务数据。

### 4.3 DTO/VO 与实体分层
- Controller 层仅接收/返回 DTO/VO，不直接暴露 Entity 字段。
- Service 层负责在 DTO 与 Entity 之间进行转换。
- 对外隐藏内部实现细节（如数据库主键、自增 ID 等可通过编码或雪花 ID 等方式抽象）。

## 五、权限与角色视角下的接口访问

- 小程序普通用户：
  - 允许访问 `/api/auth/**` `/api/user/**` `/api/tasks/**` `/api/points/**` `/api/mall/**` `/api/community/**` 等。
- 后台运营/管理员：
  - 允许访问 `/api/admin/**` 下的管理接口。
- 接口权限控制的具体规则见《安全与加密设计说明》中“授权设计”章节。
