# 系统总体架构设计说明

## 一、文档信息
- **文档目的**：描述本项目整体技术架构、分层结构与基础设施选型，为后续详细设计与开发提供统一参考。
- **适用读者**：产品负责人、后端/前端开发、架构师、运维工程师。
- **关联文档**：
  - 《需求.md》
  - 《任务列表.md》1.3 小节
  - 《业务模块与接口分层设计文档》
  - 《安全与加密设计说明》

## 二、总体技术栈选型

### 2.1 客户端
- **微信小程序端**：
  - 框架：uni-app（基于 Vue3），使用 HBuilder X 开发与构建。
  - 目标端：微信小程序。
- **后台管理端 Web**：
  - 框架：Vue3 + Element Plus。
  - 构建工具：Vite 或 Webpack（二选一，建议 Vite）。

### 2.2 服务端
- **后端技术栈**：
  - 语言：Java 8
  - 框架：Spring Boot 2.7.18
  - ORM：MyBatis-Plus
  - 构建工具：Maven
  - API 文档：Springdoc OpenAPI
  - 分布式组件（按需预留）：Spring Cloud 2021.0.9（先以单体部署为主，仅在需要时引入具体组件）。

### 2.3 基础设施
- 数据库：MySQL 5.6
- 缓存：Redis
- 消息队列：RabbitMQ
- 文件/媒体存储：对象存储（如 OSS、COS 或本地文件服务器，根据实际环境确定）。
- 部署环境：Linux 服务器（建议），通过 Nginx 反向代理 + HTTPS 暴露服务。

## 三、系统总体架构

### 3.1 架构形态
- 第一阶段采用 **单体应用 + 清晰分层** 架构：
  - 所有业务模块运行在同一 Spring Boot 应用内。
  - 通过领域划分、包结构和接口边界，预留后续按模块拆分为独立服务的空间。
- 前后端完全分离：
  - 小程序 / 后台管理端 仅通过 HTTP/HTTPS 调用 REST 接口，不与数据库直接交互。

### 3.2 逻辑视图
- **客户端层**：
  - 微信小程序（C 端用户）。
  - 后台管理 Web（运营 / 管理人员）。
- **接入层**：
  - Nginx / 反向代理，统一处理 HTTPS、域名、路由转发。
- **应用服务层（单体应用内部）**：
  - 用户与权限模块
  - 积分中心模块
  - 任务与模板模块
  - 社区内容模块
  - 积分商城与奖品模块
  - 支付与结算模块
  - 集成模块（CRM、mall.wisualarm.com、消息推送）
- **基础设施层**：
  - MySQL（持久化存储）
  - Redis（缓存、会话、热点数据）
  - RabbitMQ（异步任务、消息通知）
  - 对象存储（图片/视频等大文件）

### 3.3 简要架构示意（文字）
- 小程序 / 后台 Web → Nginx → Spring Boot 应用 → MySQL / Redis / RabbitMQ / 对象存储

## 四、后端分层架构设计

### 4.1 分层说明
- **Controller 层**：
  - 暴露 REST 接口，负责请求参数校验、鉴权结果解析、调用 Service。
  - 不直接操作数据库，不包含复杂业务逻辑。
- **Service 层**：
  - 承载业务逻辑和领域规则，协调多个领域对象与 Repository。
  - 控制事务边界（如 @Transactional）。
- **Repository（Mapper）层**：
  - 通过 MyBatis-Plus 操作数据库。
  - 仅负责数据 CRUD，不包含业务逻辑。
- **Domain Model（实体/值对象）**：
  - 反映核心业务概念：用户、积分账户、任务、礼品、提现记录等。
  - 避免在业务逻辑中直接使用数据库映射对象做一切事，可按需定义领域对象。

### 4.2 数据传输对象
- 定义 DTO / VO 与 Entity 分离策略：
  - 对外接口使用 DTO/VO，内部持久化使用 Entity。
  - 避免直接将数据库字段全部暴露给前端。
- 针对小程序端与后台端，可定义不同的 DTO 视图，以满足不同展示需求。

## 五、模块划分概览

- **用户与权限模块**：用户注册登录、角色、权限、Token、CRM 绑定等。
- **积分中心模块**：积分账户、积分流水、积分规则、积分结算。
- **任务与模板模块**：任务定义、模板管理、任务参与与审核。
- **社区内容模块**：帖子、评论、分类、内容审核（如需要）。
- **积分商城与奖品模块**：礼品管理、库存、兑换记录、提现记录、黑名单。
- **支付与结算模块**：微信支付/提现对接、对账、财务对账数据输出。
- **集成模块**：
  - CRM 同步/导入接口。
  - mall.wisualarm.com 嵌入与参数传递。
  - 消息推送（如任务通知、积分到账通知）。

## 六、部署与环境规划

- **环境**：
  - 开发环境（dev）：本地/测试服务器，连接测试库与测试微信环境。
  - 测试环境（test）：联调与回归测试使用。
  - 生产环境（prod）：正式对外服务。
- **部署建议**：
  - Spring Boot 应用以 Jar 形式部署，前置 Nginx。
  - Redis、RabbitMQ 可与应用同机或独立主机部署，视规模而定。
  - 日志输出到文件，配合 logrotate 或日志采集系统。

## 七、横切关注点概览

- **认证与授权**：采用 Token（建议 JWT），统一认证中间件处理。
- **日志与监控**：定义统一日志格式，关键请求打上 traceId，便于排查问题。
- **缓存策略**：针对配置、热点查询等场景使用 Redis 缓存，明确过期与失效策略。
- **异步处理**：任务通知、消息推送、耗时统计任务使用 RabbitMQ 异步处理。
- **扩展性**：
  - 包结构按模块划分，后续可以按模块拆分为独立服务。
  - 与第三方系统交互的代码集中在集成模块，避免散落全系统。
