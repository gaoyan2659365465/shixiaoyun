{"version":3,"file":"coupon.js","sources":["pages/coupon/coupon.vue","E:/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY291cG9uL2NvdXBvbi52dWU"],"sourcesContent":["<template>\r\n  <view class=\"coupon-page\">\r\n    <!-- 顶部导航栏 -->\r\n    <view class=\"navbar\" :style=\"{ paddingTop: statusBarHeight + 'px' }\">\r\n      <view class=\"navbar-content\">\r\n        <view class=\"navbar-left\" @click=\"handleBack\">\r\n          <text class=\"back-icon\">←</text>\r\n        </view>\r\n        <view class=\"navbar-title\">卡券中心</view>\r\n        <view class=\"navbar-right\" @click=\"handleProfile\">\r\n          <image class=\"avatar\" :src=\"userAvatar\" mode=\"aspectFill\"></image>\r\n        </view>\r\n      </view>\r\n    </view>\r\n    \r\n    <!-- Tab切换栏 -->\r\n    <coupon-tab-bar \r\n      :current-tab=\"currentTab\" \r\n      :stats=\"stats\"\r\n      @change=\"handleTabChange\"\r\n    />\r\n    \r\n    <!-- 卡券列表 -->\r\n    <scroll-view \r\n      class=\"coupon-list\"\r\n      scroll-y\r\n      :refresher-enabled=\"true\"\r\n      :refresher-triggered=\"refreshing\"\r\n      @refresherrefresh=\"handleRefresh\"\r\n      @scrolltolower=\"handleLoadMore\"\r\n    >\r\n      <!-- 卡券卡片列表 -->\r\n      <view v-if=\"couponList.length > 0\" class=\"list-content\">\r\n        <coupon-card\r\n          v-for=\"coupon in couponList\"\r\n          :key=\"coupon.id\"\r\n          :coupon=\"coupon\"\r\n          @use=\"handleUseCoupon\"\r\n        />\r\n        \r\n        <!-- 加载更多提示 -->\r\n        <view v-if=\"hasMore\" class=\"load-more\">\r\n          <text v-if=\"loading\" class=\"loading-text\">加载中...</text>\r\n          <text v-else class=\"load-text\">上拉加载更多</text>\r\n        </view>\r\n        <view v-else class=\"no-more\">\r\n          <text class=\"no-more-text\">没有更多了</text>\r\n        </view>\r\n      </view>\r\n      \r\n      <!-- 空状态 -->\r\n      <coupon-empty\r\n        v-else-if=\"!loading\"\r\n        :empty-text=\"emptyText\"\r\n        @refresh=\"handleRefresh\"\r\n      />\r\n      \r\n      <!-- 首次加载 -->\r\n      <view v-if=\"loading && couponList.length === 0\" class=\"loading-wrapper\">\r\n        <text class=\"loading-text\">加载中...</text>\r\n      </view>\r\n    </scroll-view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport CouponTabBar from './components/CouponTabBar.vue';\r\nimport CouponCard from './components/CouponCard.vue';\r\nimport CouponEmpty from './components/CouponEmpty.vue';\r\nimport { getCouponList, useCoupon, getCouponStats } from '@/api/coupon.js';\r\n\r\nexport default {\r\n  name: 'CouponPage',\r\n  components: {\r\n    CouponTabBar,\r\n    CouponCard,\r\n    CouponEmpty\r\n  },\r\n  data() {\r\n    return {\r\n      // 当前Tab\r\n      currentTab: 'unused',\r\n      // 卡券列表\r\n      couponList: [],\r\n      // 统计数据\r\n      stats: {\r\n        unused: 0,\r\n        used: 0,\r\n        expired: 0\r\n      },\r\n      // 分页参数\r\n      page: 1,\r\n      pageSize: 10,\r\n      hasMore: true,\r\n      // 加载状态\r\n      loading: false,\r\n      refreshing: false,\r\n      // 用户头像\r\n      userAvatar: '/static/logo.png',\r\n      // 状态栏高度\r\n      statusBarHeight: 0\r\n    };\r\n  },\r\n  computed: {\r\n    /**\r\n     * 空状态文本\r\n     */\r\n    emptyText() {\r\n      const textMap = {\r\n        unused: '暂无未使用的卡券',\r\n        used: '暂无已使用的卡券',\r\n        expired: '暂无已过期的卡券'\r\n      };\r\n      return textMap[this.currentTab] || '暂无卡券';\r\n    }\r\n  },\r\n  onLoad() {\r\n    // 获取系统信息（状态栏高度）\r\n    const systemInfo = uni.getSystemInfoSync();\r\n    this.statusBarHeight = systemInfo.statusBarHeight || 0;\r\n\r\n    // 页面加载时获取数据\r\n    this.loadStats();\r\n    this.loadCouponList();\r\n  },\r\n  methods: {\r\n    /**\r\n     * 加载统计数据\r\n     */\r\n    async loadStats() {\r\n      try {\r\n        const res = await getCouponStats();\r\n        if (res.code === 200) {\r\n          this.stats = res.data;\r\n        }\r\n      } catch (error) {\r\n        console.error('加载统计数据失败:', error);\r\n      }\r\n    },\r\n    \r\n    /**\r\n     * 加载卡券列表\r\n     * @param {boolean} isRefresh - 是否为刷新操作\r\n     */\r\n    async loadCouponList(isRefresh = false) {\r\n      if (this.loading) return;\r\n      \r\n      this.loading = true;\r\n      \r\n      try {\r\n        const res = await getCouponList({\r\n          status: this.currentTab,\r\n          page: this.page,\r\n          pageSize: this.pageSize\r\n        });\r\n        \r\n        if (res.code === 200) {\r\n          const { list, hasMore } = res.data;\r\n          \r\n          if (isRefresh) {\r\n            this.couponList = list;\r\n          } else {\r\n            this.couponList = [...this.couponList, ...list];\r\n          }\r\n          \r\n          this.hasMore = hasMore;\r\n        }\r\n      } catch (error) {\r\n        console.error('加载卡券列表失败:', error);\r\n        uni.showToast({\r\n          title: '加载失败',\r\n          icon: 'none',\r\n          duration: 2000\r\n        });\r\n      } finally {\r\n        this.loading = false;\r\n        this.refreshing = false;\r\n      }\r\n    },\r\n    \r\n    /**\r\n     * 处理Tab切换\r\n     * @param {string} tab - 新的Tab值\r\n     */\r\n    handleTabChange(tab) {\r\n      this.currentTab = tab;\r\n      this.page = 1;\r\n      this.couponList = [];\r\n      this.hasMore = true;\r\n      this.loadCouponList(true);\r\n    },\r\n    \r\n    /**\r\n     * 处理下拉刷新\r\n     */\r\n    handleRefresh() {\r\n      this.refreshing = true;\r\n      this.page = 1;\r\n      this.hasMore = true;\r\n      this.loadStats();\r\n      this.loadCouponList(true);\r\n    },\r\n    \r\n    /**\r\n     * 处理上拉加载更多\r\n     */\r\n    handleLoadMore() {\r\n      if (!this.hasMore || this.loading) return;\r\n      \r\n      this.page += 1;\r\n      this.loadCouponList();\r\n    },\r\n    \r\n    /**\r\n     * 处理使用卡券\r\n     * @param {Object} coupon - 卡券对象\r\n     */\r\n    async handleUseCoupon(coupon) {\r\n      // 显示确认对话框\r\n      uni.showModal({\r\n        title: '确认使用',\r\n        content: `确定要使用\"${coupon.name}\"吗？`,\r\n        success: async (res) => {\r\n          if (res.confirm) {\r\n            try {\r\n              uni.showLoading({\r\n                title: '使用中...',\r\n                mask: true\r\n              });\r\n              \r\n              const result = await useCoupon(coupon.id);\r\n              \r\n              uni.hideLoading();\r\n              \r\n              if (result.code === 200) {\r\n                uni.showToast({\r\n                  title: '使用成功',\r\n                  icon: 'success',\r\n                  duration: 2000\r\n                });\r\n                \r\n                // 刷新列表和统计\r\n                this.handleRefresh();\r\n              }\r\n            } catch (error) {\r\n              uni.hideLoading();\r\n              uni.showToast({\r\n                title: error.message || '使用失败',\r\n                icon: 'none',\r\n                duration: 2000\r\n              });\r\n            }\r\n          }\r\n        }\r\n      });\r\n    },\r\n    \r\n    /**\r\n     * 返回上一页\r\n     */\r\n    handleBack() {\r\n      uni.navigateBack({\r\n        delta: 1\r\n      });\r\n    },\r\n    \r\n    /**\r\n     * 跳转到个人中心\r\n     */\r\n    handleProfile() {\r\n      uni.switchTab({\r\n        url: '/pages/profile/profile'\r\n      });\r\n    }\r\n  }\r\n};\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.coupon-page {\r\n  min-height: 100vh;\r\n  background-color: #F5F5F5;\r\n  display: flex;\r\n  flex-direction: column;\r\n  \r\n  // 顶部导航栏\r\n  .navbar {\r\n    position: sticky;\r\n    top: 0;\r\n    z-index: 100;\r\n    background-color: #FFFFFF;\r\n    border-bottom: 1rpx solid #E5E5E5;\r\n\r\n    .navbar-content {\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: space-between;\r\n      height: 88rpx;\r\n      padding: 0 30rpx;\r\n    }\r\n\r\n    .navbar-left,\r\n    .navbar-right {\r\n      width: 80rpx;\r\n      display: flex;\r\n      align-items: center;\r\n    }\r\n\r\n    .navbar-left {\r\n      justify-content: flex-start;\r\n\r\n      .back-icon {\r\n        font-size: 40rpx;\r\n        color: #333333;\r\n        font-weight: bold;\r\n      }\r\n    }\r\n\r\n    .navbar-title {\r\n      flex: 1;\r\n      text-align: center;\r\n      font-size: 32rpx;\r\n      color: #333333;\r\n      font-weight: bold;\r\n    }\r\n\r\n    .navbar-right {\r\n      justify-content: flex-end;\r\n\r\n      .avatar {\r\n        width: 56rpx;\r\n        height: 56rpx;\r\n        border-radius: 50%;\r\n        border: 2rpx solid #E5E5E5;\r\n      }\r\n    }\r\n  }\r\n  \r\n  // 卡券列表\r\n  .coupon-list {\r\n    flex: 1;\r\n    height: calc(100vh - 88rpx - 124rpx);\r\n    \r\n    .list-content {\r\n      padding: 24rpx 0;\r\n    }\r\n    \r\n    // 加载更多\r\n    .load-more,\r\n    .no-more {\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      padding: 40rpx 0;\r\n      \r\n      .loading-text,\r\n      .load-text,\r\n      .no-more-text {\r\n        font-size: 24rpx;\r\n        color: #999999;\r\n      }\r\n    }\r\n    \r\n    // 首次加载\r\n    .loading-wrapper {\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      padding: 120rpx 0;\r\n      \r\n      .loading-text {\r\n        font-size: 28rpx;\r\n        color: #999999;\r\n      }\r\n    }\r\n  }\r\n}\r\n</style>","import MiniProgramPage from 'C:/Users/26593/Documents/HBuilderProjects/shixiaoyun/pages/coupon/coupon.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","getCouponStats","getCouponList","useCoupon"],"mappings":"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"}